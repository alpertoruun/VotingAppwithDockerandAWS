{% extends "_base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <div class="col">
      <div class="card shadow">
        <div class="card-body text-center">
          <h2 class="mb-4">Yüz Doğrulama</h2>
          <video id="video" autoplay playsinline class="border rounded" width="320" height="240"></video>
          <canvas id="canvas" style="display: none;"></canvas>
          <form id="faceControlForm" action="{{ url_for('core.face_control', token=token) }}" method="post" enctype="multipart/form-data" style="display: none;">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="file" id="imageInput" name="image" accept="image/*">
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const faceControlForm = document.getElementById('faceControlForm');
  const imageInput = document.getElementById('imageInput');
  let captureCount = 0;
  const maxCaptures = 3;
  let matches = 0;
  let redirectUrl = null;  // Başarılı yönlendirme URL'si

  navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
      video.srcObject = stream;
      startCapturing();
    })
    .catch(error => {
      console.error("Kameraya erişim sağlanamadı:", error);
      alert("Kameraya erişim sağlanamadı.");
    });

  function startCapturing() {
    captureCount = 0;
    matches = 0;
    redirectUrl = null;  // Yönlendirme URL'sini sıfırlayın
    const captureInterval = setInterval(() => {
      if (captureCount < maxCaptures) {
        captureImage();
        captureCount++;
      } else {
        clearInterval(captureInterval);
        evaluateResults();
      }
    }, 1500);
  }

  function captureImage() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const context = canvas.getContext('2d');
    context.drawImage(video, 0, 0, canvas.width, canvas.height);

    canvas.toBlob(blob => {
      const file = new File([blob], `capture_${captureCount}.jpg`, { type: "image/jpeg" });
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      imageInput.files = dataTransfer.files;

      const formData = new FormData(faceControlForm);

      fetch(faceControlForm.action, {
        method: "POST",
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          matches++;
          if (!redirectUrl) {  // İlk başarılı eşleşmede yönlendirme URL'sini al
            redirectUrl = data.redirect_url;
          }
        }
      })
      .catch(error => {
        console.error("Yüz doğrulama hatası:", error);
      });
    }, 'image/jpeg');
  }

  function evaluateResults() {
    if (matches >= 2 && redirectUrl) {
      window.location.href = redirectUrl;
    } else {
      alert("Yüz doğrulama başarısız. Lütfen tekrar deneyin.");
      setTimeout(startCapturing, 500);
    }
  }
</script>
{% endblock %}
